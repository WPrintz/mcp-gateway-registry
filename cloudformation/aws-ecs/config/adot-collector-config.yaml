# AWS Distro for OpenTelemetry (ADOT) Collector Configuration
# This config collects metrics from ECS tasks and exports to Amazon Managed Prometheus

extensions:
  health_check:
  sigv4auth:
    region: ${AWS_REGION}
    service: aps

receivers:
  # Prometheus receiver scrapes metrics from application endpoints
  prometheus:
    config:
      global:
        scrape_interval: 15s
        scrape_timeout: 10s
      scrape_configs:
        # Scrape Registry service metrics
        - job_name: 'mcp-registry'
          static_configs:
            - targets: ['localhost:7860']
          metrics_path: /metrics
          scheme: http

        # Scrape Auth Server metrics
        - job_name: 'mcp-auth-server'
          static_configs:
            - targets: ['localhost:8080']
          metrics_path: /metrics
          scheme: http

  # AWS ECS Container Metrics (from Task Metadata)
  awsecscontainermetrics:
    collection_interval: 20s

processors:
  # Batch processor for efficient export
  batch:
    timeout: 30s
    send_batch_size: 1000

  # Resource processor to add metadata
  resource:
    attributes:
      - key: environment
        value: ${ENVIRONMENT_NAME}
        action: upsert
      - key: cluster
        value: ${ECS_CLUSTER}
        action: upsert

  # Filter out unnecessary metrics
  filter:
    metrics:
      include:
        match_type: regexp
        metric_names:
          - http_.*
          - process_.*
          - python_.*
          - ecs_.*
          - container_.*

exporters:
  # Export to Amazon Managed Prometheus
  prometheusremotewrite:
    endpoint: ${AMP_REMOTE_WRITE_ENDPOINT}
    auth:
      authenticator: sigv4auth
    retry_on_failure:
      enabled: true
      initial_interval: 5s
      max_interval: 30s
      max_elapsed_time: 300s

  # Debug logging (disabled in production)
  logging:
    loglevel: warn

service:
  extensions: [health_check, sigv4auth]
  pipelines:
    metrics:
      receivers: [prometheus, awsecscontainermetrics]
      processors: [batch, resource, filter]
      exporters: [prometheusremotewrite]
