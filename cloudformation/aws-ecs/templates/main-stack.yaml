AWSTemplateFormatVersion: '2010-09-09'
Description: >
  MCP Gateway Registry - Main Stack (Parent Orchestration)
  Orchestrates all nested stacks for complete MCP Gateway Registry deployment.
  Target Region: us-west-2

Parameters:
  EnvironmentName:
    Type: String
    Default: mcp-gateway
    Description: Name prefix for all resources

  # Network Configuration
  VpcCidr:
    Type: String
    Default: 10.0.0.0/16
    Description: CIDR block for VPC

  IngressCidrBlocks:
    Type: String
    Default: 0.0.0.0/0
    Description: CIDR blocks allowed to access ALBs

  # Domain Configuration
  BaseDomain:
    Type: String
    Default: ''
    Description: Base domain for regional URLs (leave empty to skip DNS/certs)

  HostedZoneId:
    Type: String
    Default: ''
    Description: Route53 Hosted Zone ID (leave empty to skip DNS/certs)

  UseRegionalDomains:
    Type: String
    Default: 'true'
    AllowedValues: ['true', 'false']
    Description: Use region-based domain names

  # Database Credentials
  KeycloakDatabaseUsername:
    Type: String
    Default: keycloak
    Description: Keycloak database username
    NoEcho: true

  KeycloakDatabasePassword:
    Type: String
    Default: McpGateway2025!
    Description: Keycloak database password (min 8 characters)
    NoEcho: true
    MinLength: 8

  KeycloakAdminPassword:
    Type: String
    Default: AdminPassword2025!
    Description: Keycloak admin password (min 12 characters)
    NoEcho: true
    MinLength: 12

  # Aurora Serverless Scaling
  DatabaseMinACU:
    Type: Number
    Default: 0.5
    Description: Minimum Aurora Capacity Units

  DatabaseMaxACU:
    Type: Number
    Default: 2
    Description: Maximum Aurora Capacity Units

  # Container Image Repositories (ECR URIs constructed dynamically using AWS::AccountId and AWS::Region)
  RegistryImageRepo:
    Type: String
    Default: 'mcp-gateway-registry'
    Description: ECR repository name for Registry service

  RegistryImageTag:
    Type: String
    Default: 'latest'
    Description: Image tag for Registry service

  AuthServerImageRepo:
    Type: String
    Default: 'mcp-gateway-auth-server'
    Description: ECR repository name for Auth Server

  AuthServerImageTag:
    Type: String
    Default: 'latest'
    Description: Image tag for Auth Server

  KeycloakImageRepo:
    Type: String
    Default: 'mcp-gateway-keycloak'
    Description: ECR repository name for Keycloak

  KeycloakImageTag:
    Type: String
    Default: 'latest'
    Description: Image tag for Keycloak

  CurrentTimeImageRepo:
    Type: String
    Default: 'mcp-gateway-currenttime'
    Description: ECR repository name for CurrentTime MCP server

  CurrentTimeImageTag:
    Type: String
    Default: 'latest'
    Description: Image tag for CurrentTime MCP server

  McpgwImageRepo:
    Type: String
    Default: 'mcp-gateway-mcpgw'
    Description: ECR repository name for MCPGW MCP server

  McpgwImageTag:
    Type: String
    Default: 'latest'
    Description: Image tag for MCPGW MCP server

  RealServerFakeToolsImageRepo:
    Type: String
    Default: 'mcp-gateway-realserverfaketools'
    Description: ECR repository name for RealServerFakeTools MCP server

  RealServerFakeToolsImageTag:
    Type: String
    Default: 'latest'
    Description: Image tag for RealServerFakeTools MCP server

  FlightBookingAgentImageRepo:
    Type: String
    Default: 'mcp-gateway-flight-booking-agent'
    Description: ECR repository name for Flight Booking Agent

  FlightBookingAgentImageTag:
    Type: String
    Default: 'latest'
    Description: Image tag for Flight Booking Agent

  TravelAssistantAgentImageRepo:
    Type: String
    Default: 'mcp-gateway-travel-assistant-agent'
    Description: ECR repository name for Travel Assistant Agent

  TravelAssistantAgentImageTag:
    Type: String
    Default: 'latest'
    Description: Image tag for Travel Assistant Agent

  # Resource Configuration
  ServiceCpu:
    Type: String
    Default: '512'
    Description: CPU units for main services

  ServiceMemory:
    Type: String
    Default: '1024'
    Description: Memory (MB) for main services

  KeycloakCpu:
    Type: String
    Default: '1024'
    Description: CPU units for Keycloak

  KeycloakMemory:
    Type: String
    Default: '2048'
    Description: Memory (MB) for Keycloak

  # Auto Scaling Configuration
  EnableAutoScaling:
    Type: String
    Default: 'true'
    AllowedValues: ['true', 'false']
    Description: Enable auto scaling for ECS services

  MinCapacity:
    Type: Number
    Default: 1
    Description: Minimum number of tasks

  MaxCapacity:
    Type: Number
    Default: 4
    Description: Maximum number of tasks

  TargetCpuUtilization:
    Type: Number
    Default: 70
    Description: Target CPU utilization percentage

  TargetMemoryUtilization:
    Type: Number
    Default: 80
    Description: Target memory utilization percentage

  # Keycloak Configuration
  KeycloakLogLevel:
    Type: String
    Default: 'INFO'
    Description: Keycloak log level
    AllowedValues:
      - 'ALL'
      - 'DEBUG'
      - 'ERROR'
      - 'FATAL'
      - 'INFO'
      - 'OFF'
      - 'TRACE'
      - 'WARN'

  # Template S3 Location (for nested stacks)
  # NOTE: TemplateS3Prefix must include trailing slash (e.g., "path/to/templates/")
  # This convention allows direct copy to Workshop Studio which injects prefix with trailing slash
  TemplateS3Bucket:
    Type: String
    Default: 'your_template_bucket_here'
    Description: S3 bucket containing nested stack templates

  TemplateS3Prefix:
    Type: String
    Default: 'your_template_prefix_here/'
    Description: S3 prefix for nested stack templates (must include trailing slash)

Conditions:
  UseRegionalDomainsCondition: !Equals [!Ref UseRegionalDomains, 'true']
  HasDnsConfig: !And
    - !Not [!Equals [!Ref BaseDomain, '']]
    - !Not [!Equals [!Ref HostedZoneId, '']]

Resources:

  #============================================================================
  # Network Stack
  # Approx. 160 sec to deploy
  #============================================================================
  NetworkStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub 'https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}network-stack.yaml'
      Parameters:
        EnvironmentName: !Ref EnvironmentName
        VpcCidr: !Ref VpcCidr
        IngressCidrBlocks: !Ref IngressCidrBlocks
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-network

  #============================================================================
  # Data Stack
  # Approx. 1200 sec to deploy
  #============================================================================
  DataStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: NetworkStack
    Properties:
      TemplateURL: !Sub 'https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}data-stack.yaml'
      Parameters:
        EnvironmentName: !Ref EnvironmentName
        VpcId: !GetAtt NetworkStack.Outputs.VpcId
        VpcCidr: !Ref VpcCidr
        PrivateSubnet1: !GetAtt NetworkStack.Outputs.PrivateSubnet1
        PrivateSubnet2: !GetAtt NetworkStack.Outputs.PrivateSubnet2
        PrivateSubnet3: !GetAtt NetworkStack.Outputs.PrivateSubnet3
        DatabaseSecurityGroupId: !GetAtt NetworkStack.Outputs.DatabaseSecurityGroupId
        EfsSecurityGroupId: !GetAtt NetworkStack.Outputs.EfsSecurityGroupId
        KeycloakDatabaseUsername: !Ref KeycloakDatabaseUsername
        KeycloakDatabasePassword: !Ref KeycloakDatabasePassword
        KeycloakAdminPassword: !Ref KeycloakAdminPassword
        DatabaseMinACU: !Ref DatabaseMinACU
        DatabaseMaxACU: !Ref DatabaseMaxACU
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-data

  #============================================================================
  # Compute Stack
  # Approx. 700 sec to deploy
  #============================================================================
  ComputeStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: DataStack
    Properties:
      TemplateURL: !Sub 'https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}compute-stack.yaml'
      Parameters:
        EnvironmentName: !Ref EnvironmentName
        BaseDomain: !Ref BaseDomain
        HostedZoneId: !Ref HostedZoneId
        UseRegionalDomains: !Ref UseRegionalDomains
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-compute

  #============================================================================
  # Services Stack
  # Approx. 1500 sec to deploy
  # Note: Services stack uses ImportValue for cross-stack references
  # Only passing parameters that are defined in services-stack.yaml
  #============================================================================
  ServicesStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: ComputeStack
    Properties:
      TemplateURL: !Sub 'https://${TemplateS3Bucket}.s3.${AWS::Region}.amazonaws.com/${TemplateS3Prefix}services-stack.yaml'
      Parameters:
        EnvironmentName: !Ref EnvironmentName
        RegistryImageRepo: !Ref RegistryImageRepo
        RegistryImageTag: !Ref RegistryImageTag
        AuthServerImageRepo: !Ref AuthServerImageRepo
        AuthServerImageTag: !Ref AuthServerImageTag
        KeycloakImageRepo: !Ref KeycloakImageRepo
        KeycloakImageTag: !Ref KeycloakImageTag
        CurrentTimeImageRepo: !Ref CurrentTimeImageRepo
        CurrentTimeImageTag: !Ref CurrentTimeImageTag
        McpgwImageRepo: !Ref McpgwImageRepo
        McpgwImageTag: !Ref McpgwImageTag
        RealServerFakeToolsImageRepo: !Ref RealServerFakeToolsImageRepo
        RealServerFakeToolsImageTag: !Ref RealServerFakeToolsImageTag
        FlightBookingAgentImageRepo: !Ref FlightBookingAgentImageRepo
        FlightBookingAgentImageTag: !Ref FlightBookingAgentImageTag
        TravelAssistantAgentImageRepo: !Ref TravelAssistantAgentImageRepo
        TravelAssistantAgentImageTag: !Ref TravelAssistantAgentImageTag
        ServiceCpu: !Ref ServiceCpu
        ServiceMemory: !Ref ServiceMemory
        KeycloakCpu: !Ref KeycloakCpu
        KeycloakMemory: !Ref KeycloakMemory
        EnableAutoScaling: !Ref EnableAutoScaling
        MinCapacity: !Ref MinCapacity
        MaxCapacity: !Ref MaxCapacity
        TargetCpuUtilization: !Ref TargetCpuUtilization
        TargetMemoryUtilization: !Ref TargetMemoryUtilization
        KeycloakLogLevel: !Ref KeycloakLogLevel
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-services

#============================================================================
# Outputs
#============================================================================
Outputs:
  # URL Outputs (CloudFront HTTPS)
  MCPGatewayUrl:
    Description: MCP Gateway URL (HTTPS via CloudFront)
    Value: !GetAtt ComputeStack.Outputs.MainCloudFrontUrl

  KeycloakUrl:
    Description: Keycloak URL (HTTPS via CloudFront)
    Value: !GetAtt ComputeStack.Outputs.KeycloakCloudFrontUrl

  # ECS Cluster Output
  MCPGatewayEcsClusterArn:
    Description: MCP Gateway ECS Cluster ARN
    Value: !GetAtt ComputeStack.Outputs.MainEcsClusterArn

  # Secrets Manager Console URLs
  MCPGatewayAdminPassword:
    Description: Secrets Manager console URL for MCP Gateway Admin Password
    Value: !Sub 'https://${AWS::Region}.console.aws.amazon.com/secretsmanager/secret?name=${EnvironmentName}-admin-password&region=${AWS::Region}'

  MCPGatewaySecretKey:
    Description: Secrets Manager console URL for MCP Gateway Secret Key
    Value: !Sub 'https://${AWS::Region}.console.aws.amazon.com/secretsmanager/secret?name=${EnvironmentName}-secret-key&region=${AWS::Region}'

  # SSM Parameter Store Console URLs
  KeycloakAdminPassword:
    Description: SSM Parameter Store console URL for Keycloak Admin Password
    Value: !Sub 'https://${AWS::Region}.console.aws.amazon.com/systems-manager/parameters/keycloak/admin_password/description?region=${AWS::Region}'

  # Keycloak Secrets (Secrets Manager)
  KeycloakDatabaseCredentials:
    Description: Secrets Manager console URL for Keycloak Database Credentials
    Value: !Sub 'https://${AWS::Region}.console.aws.amazon.com/secretsmanager/secret?name=${EnvironmentName}/keycloak/database&region=${AWS::Region}'

  KeycloakClientSecret:
    Description: Secrets Manager console URL for Keycloak Web Client Secret
    Value: !Sub 'https://${AWS::Region}.console.aws.amazon.com/secretsmanager/secret?name=${EnvironmentName}-keycloak-client-secret&region=${AWS::Region}'

  KeycloakM2MClientSecret:
    Description: Secrets Manager console URL for Keycloak M2M Client Secret
    Value: !Sub 'https://${AWS::Region}.console.aws.amazon.com/secretsmanager/secret?name=${EnvironmentName}-keycloak-m2m-client-secret&region=${AWS::Region}'
