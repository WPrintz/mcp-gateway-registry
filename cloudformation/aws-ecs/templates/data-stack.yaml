AWSTemplateFormatVersion: '2010-09-09'
Description: >
  MCP Gateway Registry - Data Stack (Consolidated)
  Creates EFS, Aurora Serverless v2, RDS Proxy, Secrets Manager, SSM Parameters, and KMS.
  Matches terraform/aws-ecs/modules/mcp-gateway/storage.tf, secrets.tf and keycloak-database.tf
  Target Region: us-west-2

Parameters:
  EnvironmentName:
    Type: String
    Default: mcp-gateway
    Description: Name prefix for all resources (must match network stack)

  # Network references (passed from main-stack or use ImportValue)
  VpcId:
    Type: String
    Default: ''
    Description: VPC ID (leave empty to use ImportValue)

  VpcCidr:
    Type: String
    Default: ''
    Description: VPC CIDR block (leave empty to use ImportValue)

  PrivateSubnet1:
    Type: String
    Default: ''
    Description: Private Subnet 1 ID (leave empty to use ImportValue)

  PrivateSubnet2:
    Type: String
    Default: ''
    Description: Private Subnet 2 ID (leave empty to use ImportValue)

  PrivateSubnet3:
    Type: String
    Default: ''
    Description: Private Subnet 3 ID (leave empty to use ImportValue)

  DatabaseSecurityGroupId:
    Type: String
    Default: ''
    Description: Database Security Group ID (leave empty to use ImportValue)

  EfsSecurityGroupId:
    Type: String
    Default: ''
    Description: EFS Security Group ID (leave empty to use ImportValue)

  # Database credentials (NoEcho for security)
  KeycloakDatabaseUsername:
    Type: String
    Default: keycloak
    Description: Keycloak database username
    NoEcho: true

  KeycloakDatabasePassword:
    Type: String
    Default: KeycloakDbPass123!
    Description: Keycloak database password
    NoEcho: true
    MinLength: 8

  KeycloakAdminPassword:
    Type: String
    Default: KeycloakAdmin123!
    Description: Keycloak admin password
    NoEcho: true
    MinLength: 12

  # Aurora Serverless scaling
  DatabaseMinACU:
    Type: Number
    Default: 0.5
    Description: Minimum Aurora Capacity Units

  DatabaseMaxACU:
    Type: Number
    Default: 2
    Description: Maximum Aurora Capacity Units

Conditions:
  UseVpcIdParam: !Not [!Equals [!Ref VpcId, '']]
  UsePrivateSubnet1Param: !Not [!Equals [!Ref PrivateSubnet1, '']]
  UsePrivateSubnet2Param: !Not [!Equals [!Ref PrivateSubnet2, '']]
  UsePrivateSubnet3Param: !Not [!Equals [!Ref PrivateSubnet3, '']]
  UseDatabaseSgParam: !Not [!Equals [!Ref DatabaseSecurityGroupId, '']]
  UseEfsSgParam: !Not [!Equals [!Ref EfsSecurityGroupId, '']]

Resources:

  #============================================================================
  # KMS Key for RDS Encryption
  #============================================================================
  RdsKmsKey:
    Type: AWS::KMS::Key
    Properties:
      Description: KMS key for RDS encryption
      EnableKeyRotation: true
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub arn:aws:iam::${AWS::AccountId}:root
            Action: kms:*
            Resource: '*'
          - Sid: Allow RDS to use the key
            Effect: Allow
            Principal:
              Service: rds.amazonaws.com
            Action:
              - kms:Encrypt
              - kms:Decrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: '*'
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-rds-kms

  RdsKmsKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub alias/${EnvironmentName}-rds
      TargetKeyId: !Ref RdsKmsKey

  #============================================================================
  # EFS File System
  #============================================================================
  EfsFileSystem:
    Type: AWS::EFS::FileSystem
    Properties:
      Encrypted: true
      PerformanceMode: generalPurpose
      ThroughputMode: bursting
      FileSystemTags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-efs

  # EFS Mount Targets (one per private subnet)
  EfsMountTarget1:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref EfsFileSystem
      SubnetId: !If
        - UsePrivateSubnet1Param
        - !Ref PrivateSubnet1
        - !ImportValue
          Fn::Sub: ${EnvironmentName}-PrivateSubnet1
      SecurityGroups:
        - !If
          - UseEfsSgParam
          - !Ref EfsSecurityGroupId
          - !ImportValue
            Fn::Sub: ${EnvironmentName}-EfsSG

  EfsMountTarget2:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref EfsFileSystem
      SubnetId: !If
        - UsePrivateSubnet2Param
        - !Ref PrivateSubnet2
        - !ImportValue
          Fn::Sub: ${EnvironmentName}-PrivateSubnet2
      SecurityGroups:
        - !If
          - UseEfsSgParam
          - !Ref EfsSecurityGroupId
          - !ImportValue
            Fn::Sub: ${EnvironmentName}-EfsSG

  EfsMountTarget3:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref EfsFileSystem
      SubnetId: !If
        - UsePrivateSubnet3Param
        - !Ref PrivateSubnet3
        - !ImportValue
          Fn::Sub: ${EnvironmentName}-PrivateSubnet3
      SecurityGroups:
        - !If
          - UseEfsSgParam
          - !Ref EfsSecurityGroupId
          - !ImportValue
            Fn::Sub: ${EnvironmentName}-EfsSG

  #============================================================================
  # EFS Access Points (6 total)
  #============================================================================
  EfsAccessPointServers:
    Type: AWS::EFS::AccessPoint
    Properties:
      FileSystemId: !Ref EfsFileSystem
      PosixUser:
        Uid: '1000'
        Gid: '1000'
      RootDirectory:
        Path: /servers
        CreationInfo:
          OwnerUid: '1000'
          OwnerGid: '1000'
          Permissions: '755'
      AccessPointTags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-servers

  EfsAccessPointModels:
    Type: AWS::EFS::AccessPoint
    Properties:
      FileSystemId: !Ref EfsFileSystem
      PosixUser:
        Uid: '1000'
        Gid: '1000'
      RootDirectory:
        Path: /models
        CreationInfo:
          OwnerUid: '1000'
          OwnerGid: '1000'
          Permissions: '755'
      AccessPointTags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-models

  EfsAccessPointLogs:
    Type: AWS::EFS::AccessPoint
    Properties:
      FileSystemId: !Ref EfsFileSystem
      PosixUser:
        Uid: '1000'
        Gid: '1000'
      RootDirectory:
        Path: /logs
        CreationInfo:
          OwnerUid: '1000'
          OwnerGid: '1000'
          Permissions: '755'
      AccessPointTags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-logs

  EfsAccessPointAgents:
    Type: AWS::EFS::AccessPoint
    Properties:
      FileSystemId: !Ref EfsFileSystem
      PosixUser:
        Uid: '1000'
        Gid: '1000'
      RootDirectory:
        Path: /agents
        CreationInfo:
          OwnerUid: '1000'
          OwnerGid: '1000'
          Permissions: '755'
      AccessPointTags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-agents

  EfsAccessPointAuthConfig:
    Type: AWS::EFS::AccessPoint
    Properties:
      FileSystemId: !Ref EfsFileSystem
      PosixUser:
        Uid: '1000'
        Gid: '1000'
      RootDirectory:
        Path: /auth_config
        CreationInfo:
          OwnerUid: '1000'
          OwnerGid: '1000'
          Permissions: '755'
      AccessPointTags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-auth-config

  EfsAccessPointMcpgwData:
    Type: AWS::EFS::AccessPoint
    Properties:
      FileSystemId: !Ref EfsFileSystem
      PosixUser:
        Uid: '1000'
        Gid: '1000'
      RootDirectory:
        Path: /mcpgw_data
        CreationInfo:
          OwnerUid: '1000'
          OwnerGid: '1000'
          Permissions: '755'
      AccessPointTags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-mcpgw-data


  #============================================================================
  # Secrets Manager Secrets
  #============================================================================
  
  # Database credentials secret
  KeycloakDbSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub ${EnvironmentName}/keycloak/database
      Description: Keycloak database credentials
      SecretString: !Sub |
        {
          "username": "${KeycloakDatabaseUsername}",
          "password": "${KeycloakDatabasePassword}"
        }
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-keycloak-db-secret

  # Application secret key
  SecretKeySecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub ${EnvironmentName}-secret-key
      Description: Secret key for MCP Gateway Registry
      GenerateSecretString:
        SecretStringTemplate: '{}'
        GenerateStringKey: secret_key
        PasswordLength: 64
        ExcludeCharacters: '"@/\'
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-secret-key

  # Admin password secret
  AdminPasswordSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub ${EnvironmentName}-admin-password
      Description: Admin password for MCP Gateway Registry
      GenerateSecretString:
        SecretStringTemplate: '{}'
        GenerateStringKey: admin_password
        PasswordLength: 32
        RequireEachIncludedType: true
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-admin-password

  # Keycloak client secret (placeholder, updated by init script)
  KeycloakClientSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub ${EnvironmentName}-keycloak-client-secret
      Description: Keycloak web client secret (updated by init script after deployment)
      SecretString: '{"client_secret": "placeholder-will-be-updated-by-init-script"}'
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-keycloak-client-secret

  # Keycloak M2M client secret (placeholder, updated by init script)
  KeycloakM2MClientSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub ${EnvironmentName}-keycloak-m2m-client-secret
      Description: Keycloak M2M client secret (updated by init script after deployment)
      SecretString: '{"client_secret": "placeholder-will-be-updated-by-init-script"}'
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-keycloak-m2m-client-secret

  #============================================================================
  # Aurora Serverless v2 Database
  #============================================================================
  
  # DB Subnet Group
  DbSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupName: !Sub ${EnvironmentName}-keycloak-subnet-group
      DBSubnetGroupDescription: Subnet group for Keycloak Aurora cluster
      SubnetIds:
        - !If
          - UsePrivateSubnet1Param
          - !Ref PrivateSubnet1
          - !ImportValue
            Fn::Sub: ${EnvironmentName}-PrivateSubnet1
        - !If
          - UsePrivateSubnet2Param
          - !Ref PrivateSubnet2
          - !ImportValue
            Fn::Sub: ${EnvironmentName}-PrivateSubnet2
        - !If
          - UsePrivateSubnet3Param
          - !Ref PrivateSubnet3
          - !ImportValue
            Fn::Sub: ${EnvironmentName}-PrivateSubnet3
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-keycloak-subnet-group

  # RDS Cluster Parameter Group
  DbClusterParameterGroup:
    Type: AWS::RDS::DBClusterParameterGroup
    Properties:
      DBClusterParameterGroupName: !Sub ${EnvironmentName}-keycloak-params
      Description: Keycloak Aurora MySQL parameter group
      Family: aurora-mysql8.0
      Parameters:
        character_set_server: utf8mb4
        collation_server: utf8mb4_unicode_ci
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-keycloak-params

  # Aurora Serverless v2 Cluster
  AuroraCluster:
    Type: AWS::RDS::DBCluster
    DependsOn: KeycloakDbSecret
    Properties:
      DBClusterIdentifier: !Sub ${EnvironmentName}-keycloak
      Engine: aurora-mysql
      EngineVersion: 8.0.mysql_aurora.3.08.2
      DatabaseName: keycloak
      MasterUsername: !Ref KeycloakDatabaseUsername
      MasterUserPassword: !Ref KeycloakDatabasePassword
      DBSubnetGroupName: !Ref DbSubnetGroup
      DBClusterParameterGroupName: !Ref DbClusterParameterGroup
      VpcSecurityGroupIds:
        - !If
          - UseDatabaseSgParam
          - !Ref DatabaseSecurityGroupId
          - !ImportValue
            Fn::Sub: ${EnvironmentName}-DatabaseSG
      BackupRetentionPeriod: 7
      PreferredBackupWindow: 02:00-04:00
      PreferredMaintenanceWindow: sun:04:00-sun:05:00
      StorageEncrypted: true
      KmsKeyId: !GetAtt RdsKmsKey.Arn
      DeletionProtection: false
      ServerlessV2ScalingConfiguration:
        MinCapacity: !Ref DatabaseMinACU
        MaxCapacity: !Ref DatabaseMaxACU
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-keycloak-cluster

  # Aurora Cluster Instance (Serverless v2)
  AuroraInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub ${EnvironmentName}-keycloak-instance
      DBClusterIdentifier: !Ref AuroraCluster
      DBInstanceClass: db.serverless
      Engine: aurora-mysql
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-keycloak-instance


  #============================================================================
  # RDS Proxy
  #============================================================================
  
  # IAM Role for RDS Proxy
  RdsProxyRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${EnvironmentName}-rds-proxy-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: rds.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: RdsProxySecretsAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: !Ref KeycloakDbSecret
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-rds-proxy-role

  # RDS Proxy
  RdsProxy:
    Type: AWS::RDS::DBProxy
    DependsOn: AuroraInstance
    Properties:
      DBProxyName: !Sub ${EnvironmentName}-keycloak-proxy
      EngineFamily: MYSQL
      Auth:
        - AuthScheme: SECRETS
          SecretArn: !Ref KeycloakDbSecret
          IAMAuth: DISABLED
      RoleArn: !GetAtt RdsProxyRole.Arn
      VpcSubnetIds:
        - !If
          - UsePrivateSubnet1Param
          - !Ref PrivateSubnet1
          - !ImportValue
            Fn::Sub: ${EnvironmentName}-PrivateSubnet1
        - !If
          - UsePrivateSubnet2Param
          - !Ref PrivateSubnet2
          - !ImportValue
            Fn::Sub: ${EnvironmentName}-PrivateSubnet2
        - !If
          - UsePrivateSubnet3Param
          - !Ref PrivateSubnet3
          - !ImportValue
            Fn::Sub: ${EnvironmentName}-PrivateSubnet3
      VpcSecurityGroupIds:
        - !If
          - UseDatabaseSgParam
          - !Ref DatabaseSecurityGroupId
          - !ImportValue
            Fn::Sub: ${EnvironmentName}-DatabaseSG
      RequireTLS: false
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-keycloak-proxy

  # RDS Proxy Target Group
  RdsProxyTargetGroup:
    Type: AWS::RDS::DBProxyTargetGroup
    Properties:
      DBProxyName: !Ref RdsProxy
      TargetGroupName: default
      DBClusterIdentifiers:
        - !Ref AuroraCluster

  #============================================================================
  # SSM SecureString Parameters via Custom Resource
  # CloudFormation doesn't support SecureString with dynamic values directly,
  # so we use a Lambda custom resource to create SecureString parameters
  # (matching Terraform's aws_ssm_parameter with type = "SecureString")
  #============================================================================
  SsmSecureStringLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${EnvironmentName}-ssm-securestring-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: SsmSecureStringPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*
              - Effect: Allow
                Action:
                  - ssm:PutParameter
                  - ssm:DeleteParameter
                  - ssm:GetParameter
                  - ssm:GetParameters
                  - ssm:AddTagsToResource
                  - ssm:RemoveTagsFromResource
                  - ssm:ListTagsForResource
                Resource: !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/keycloak/*
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-ssm-securestring-role

  SsmSecureStringLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub ${EnvironmentName}-ssm-securestring
      Runtime: python3.12
      Handler: index.handler
      Role: !GetAtt SsmSecureStringLambdaRole.Arn
      Timeout: 60
      Code:
        ZipFile: |
          import boto3
          import cfnresponse

          def handler(event, context):
              print(f"Event: {event}")
              ssm = boto3.client('ssm')
              
              try:
                  name = event['ResourceProperties']['Name']
                  
                  if event['RequestType'] == 'Delete':
                      try:
                          ssm.delete_parameter(Name=name)
                          print(f"Deleted parameter: {name}")
                      except ssm.exceptions.ParameterNotFound:
                          print(f"Parameter not found (already deleted): {name}")
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                      return
                  
                  # Create or Update
                  value = event['ResourceProperties']['Value']
                  description = event['ResourceProperties'].get('Description', '')
                  tags = event['ResourceProperties'].get('Tags', [])
                  
                  ssm.put_parameter(
                      Name=name,
                      Value=value,
                      Type='SecureString',
                      Description=description,
                      Overwrite=True
                  )
                  print(f"Created/Updated SecureString parameter: {name}")
                  
                  # Add tags if provided
                  if tags:
                      ssm.add_tags_to_resource(
                          ResourceType='Parameter',
                          ResourceId=name,
                          Tags=tags
                      )
                  
                  # Return the ARN
                  region = context.invoked_function_arn.split(':')[3]
                  account = context.invoked_function_arn.split(':')[4]
                  arn = f"arn:aws:ssm:{region}:{account}:parameter{name}"
                  
                  cfnresponse.send(event, context, cfnresponse.SUCCESS, {'Arn': arn})
                  
              except Exception as e:
                  print(f"Error: {str(e)}")
                  cfnresponse.send(event, context, cfnresponse.FAILED, {'Error': str(e)})
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-ssm-securestring

  # SSM SecureString Parameters (matching Terraform exactly)
  SsmKeycloakDatabaseUrl:
    Type: Custom::SsmSecureString
    DependsOn: SsmSecureStringLambda
    Properties:
      ServiceToken: !GetAtt SsmSecureStringLambda.Arn
      Name: /keycloak/database/url
      Value: !Sub jdbc:mysql://${AuroraCluster.Endpoint.Address}:3306/keycloak
      Description: Keycloak database JDBC URL
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-keycloak-db-url

  SsmKeycloakDatabaseUsername:
    Type: Custom::SsmSecureString
    DependsOn: SsmSecureStringLambda
    Properties:
      ServiceToken: !GetAtt SsmSecureStringLambda.Arn
      Name: /keycloak/database/username
      Value: !Ref KeycloakDatabaseUsername
      Description: Keycloak database username
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-keycloak-db-username

  SsmKeycloakDatabasePassword:
    Type: Custom::SsmSecureString
    DependsOn: SsmSecureStringLambda
    Properties:
      ServiceToken: !GetAtt SsmSecureStringLambda.Arn
      Name: /keycloak/database/password
      Value: !Ref KeycloakDatabasePassword
      Description: Keycloak database password
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-keycloak-db-password

  SsmKeycloakAdmin:
    Type: Custom::SsmSecureString
    DependsOn: SsmSecureStringLambda
    Properties:
      ServiceToken: !GetAtt SsmSecureStringLambda.Arn
      Name: /keycloak/admin
      Value: admin
      Description: Keycloak admin username
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-keycloak-admin

  SsmKeycloakAdminPassword:
    Type: Custom::SsmSecureString
    DependsOn: SsmSecureStringLambda
    Properties:
      ServiceToken: !GetAtt SsmSecureStringLambda.Arn
      Name: /keycloak/admin_password
      Value: !Ref KeycloakAdminPassword
      Description: Keycloak admin password
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-keycloak-admin-password

#============================================================================
# Outputs
#============================================================================
Outputs:
  # EFS Outputs
  EfsFileSystemId:
    Description: EFS File System ID
    Value: !Ref EfsFileSystem
    Export:
      Name: !Sub ${EnvironmentName}-EfsFileSystemId

  EfsAccessPointServersId:
    Description: EFS Access Point ID for servers
    Value: !Ref EfsAccessPointServers
    Export:
      Name: !Sub ${EnvironmentName}-EfsAccessPointServers

  EfsAccessPointModelsId:
    Description: EFS Access Point ID for models
    Value: !Ref EfsAccessPointModels
    Export:
      Name: !Sub ${EnvironmentName}-EfsAccessPointModels

  EfsAccessPointLogsId:
    Description: EFS Access Point ID for logs
    Value: !Ref EfsAccessPointLogs
    Export:
      Name: !Sub ${EnvironmentName}-EfsAccessPointLogs

  EfsAccessPointAgentsId:
    Description: EFS Access Point ID for agents
    Value: !Ref EfsAccessPointAgents
    Export:
      Name: !Sub ${EnvironmentName}-EfsAccessPointAgents

  EfsAccessPointAuthConfigId:
    Description: EFS Access Point ID for auth config
    Value: !Ref EfsAccessPointAuthConfig
    Export:
      Name: !Sub ${EnvironmentName}-EfsAccessPointAuthConfig

  EfsAccessPointMcpgwDataId:
    Description: EFS Access Point ID for mcpgw data
    Value: !Ref EfsAccessPointMcpgwData
    Export:
      Name: !Sub ${EnvironmentName}-EfsAccessPointMcpgwData

  # Database Outputs
  AuroraClusterEndpoint:
    Description: Aurora cluster endpoint
    Value: !GetAtt AuroraCluster.Endpoint.Address
    Export:
      Name: !Sub ${EnvironmentName}-AuroraClusterEndpoint

  AuroraClusterPort:
    Description: Aurora cluster port
    Value: !GetAtt AuroraCluster.Endpoint.Port
    Export:
      Name: !Sub ${EnvironmentName}-AuroraClusterPort

  RdsProxyEndpoint:
    Description: RDS Proxy endpoint
    Value: !GetAtt RdsProxy.Endpoint
    Export:
      Name: !Sub ${EnvironmentName}-RdsProxyEndpoint

  # Secrets Outputs
  KeycloakDbSecretArn:
    Description: Keycloak database secret ARN
    Value: !Ref KeycloakDbSecret
    Export:
      Name: !Sub ${EnvironmentName}-KeycloakDbSecretArn

  SecretKeySecretArn:
    Description: Application secret key ARN
    Value: !Ref SecretKeySecret
    Export:
      Name: !Sub ${EnvironmentName}-SecretKeySecretArn

  AdminPasswordSecretArn:
    Description: Admin password secret ARN
    Value: !Ref AdminPasswordSecret
    Export:
      Name: !Sub ${EnvironmentName}-AdminPasswordSecretArn

  KeycloakClientSecretArn:
    Description: Keycloak client secret ARN
    Value: !Ref KeycloakClientSecret
    Export:
      Name: !Sub ${EnvironmentName}-KeycloakClientSecretArn

  KeycloakM2MClientSecretArn:
    Description: Keycloak M2M client secret ARN
    Value: !Ref KeycloakM2MClientSecret
    Export:
      Name: !Sub ${EnvironmentName}-KeycloakM2MClientSecretArn

  # SSM Parameter Outputs (for Keycloak - matching Terraform)
  SsmKeycloakAdminArn:
    Description: SSM Parameter ARN for Keycloak admin username
    Value: !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/keycloak/admin
    Export:
      Name: !Sub ${EnvironmentName}-SsmKeycloakAdminArn

  SsmKeycloakAdminPasswordArn:
    Description: SSM Parameter ARN for Keycloak admin password
    Value: !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/keycloak/admin_password
    Export:
      Name: !Sub ${EnvironmentName}-SsmKeycloakAdminPasswordArn

  SsmKeycloakDatabaseUrlArn:
    Description: SSM Parameter ARN for Keycloak database URL
    Value: !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/keycloak/database/url
    Export:
      Name: !Sub ${EnvironmentName}-SsmKeycloakDatabaseUrlArn

  SsmKeycloakDatabaseUsernameArn:
    Description: SSM Parameter ARN for Keycloak database username
    Value: !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/keycloak/database/username
    Export:
      Name: !Sub ${EnvironmentName}-SsmKeycloakDatabaseUsernameArn

  SsmKeycloakDatabasePasswordArn:
    Description: SSM Parameter ARN for Keycloak database password
    Value: !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/keycloak/database/password
    Export:
      Name: !Sub ${EnvironmentName}-SsmKeycloakDatabasePasswordArn

  # KMS Outputs
  RdsKmsKeyArn:
    Description: RDS KMS key ARN
    Value: !GetAtt RdsKmsKey.Arn
    Export:
      Name: !Sub ${EnvironmentName}-RdsKmsKeyArn
