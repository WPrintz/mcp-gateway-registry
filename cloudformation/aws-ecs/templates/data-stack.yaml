AWSTemplateFormatVersion: '2010-09-09'
Description: >
  MCP Gateway Registry - Data Stack (Consolidated)
  Creates EFS, Aurora Serverless v2, RDS Proxy, Secrets Manager, SSM Parameters, and KMS.
  Matches terraform/aws-ecs/modules/mcp-gateway/storage.tf, secrets.tf and keycloak-database.tf
  Target Region: us-west-2

Parameters:
  EnvironmentName:
    Type: String
    Default: mcp-gateway
    Description: Name prefix for all resources (must match network stack)

  # Network references (passed from main-stack or use ImportValue)
  VpcId:
    Type: String
    Default: ''
    Description: VPC ID (leave empty to use ImportValue)

  VpcCidr:
    Type: String
    Default: ''
    Description: VPC CIDR block (leave empty to use ImportValue)

  PrivateSubnet1:
    Type: String
    Default: ''
    Description: Private Subnet 1 ID (leave empty to use ImportValue)

  PrivateSubnet2:
    Type: String
    Default: ''
    Description: Private Subnet 2 ID (leave empty to use ImportValue)

  PrivateSubnet3:
    Type: String
    Default: ''
    Description: Private Subnet 3 ID (leave empty to use ImportValue)

  DatabaseSecurityGroupId:
    Type: String
    Default: ''
    Description: Database Security Group ID (leave empty to use ImportValue)

  EfsSecurityGroupId:
    Type: String
    Default: ''
    Description: EFS Security Group ID (leave empty to use ImportValue)

  # Database credentials (NoEcho for security)
  KeycloakDatabaseUsername:
    Type: String
    Default: keycloak
    Description: Keycloak database username
    NoEcho: true

  KeycloakDatabasePassword:
    Type: String
    Default: KeycloakDbPass123!
    Description: Keycloak database password
    NoEcho: true
    MinLength: 8

  KeycloakAdminPassword:
    Type: String
    Default: KeycloakAdmin123!
    Description: Keycloak admin password
    NoEcho: true
    MinLength: 12

  # Aurora Serverless scaling
  DatabaseMinACU:
    Type: Number
    Default: 0.5
    Description: Minimum Aurora Capacity Units

  DatabaseMaxACU:
    Type: Number
    Default: 2
    Description: Maximum Aurora Capacity Units

Conditions:
  UseVpcIdParam: !Not [!Equals [!Ref VpcId, '']]
  UsePrivateSubnet1Param: !Not [!Equals [!Ref PrivateSubnet1, '']]
  UsePrivateSubnet2Param: !Not [!Equals [!Ref PrivateSubnet2, '']]
  UsePrivateSubnet3Param: !Not [!Equals [!Ref PrivateSubnet3, '']]
  UseDatabaseSgParam: !Not [!Equals [!Ref DatabaseSecurityGroupId, '']]
  UseEfsSgParam: !Not [!Equals [!Ref EfsSecurityGroupId, '']]

Resources:

  #============================================================================
  # KMS Key for RDS Encryption
  #============================================================================
  RdsKmsKey:
    Type: AWS::KMS::Key
    Properties:
      Description: KMS key for RDS encryption
      EnableKeyRotation: true
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub arn:aws:iam::${AWS::AccountId}:root
            Action: kms:*
            Resource: '*'
          - Sid: Allow RDS to use the key
            Effect: Allow
            Principal:
              Service: rds.amazonaws.com
            Action:
              - kms:Encrypt
              - kms:Decrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: '*'
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-rds-kms

  RdsKmsKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub alias/${EnvironmentName}-rds
      TargetKeyId: !Ref RdsKmsKey

  #============================================================================
  # EFS File System
  #============================================================================
  EfsFileSystem:
    Type: AWS::EFS::FileSystem
    Properties:
      Encrypted: true
      PerformanceMode: generalPurpose
      ThroughputMode: bursting
      FileSystemTags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-efs

  # EFS Mount Targets (one per private subnet)
  EfsMountTarget1:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref EfsFileSystem
      SubnetId: !If
        - UsePrivateSubnet1Param
        - !Ref PrivateSubnet1
        - !ImportValue
          Fn::Sub: ${EnvironmentName}-PrivateSubnet1
      SecurityGroups:
        - !If
          - UseEfsSgParam
          - !Ref EfsSecurityGroupId
          - !ImportValue
            Fn::Sub: ${EnvironmentName}-EfsSG

  EfsMountTarget2:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref EfsFileSystem
      SubnetId: !If
        - UsePrivateSubnet2Param
        - !Ref PrivateSubnet2
        - !ImportValue
          Fn::Sub: ${EnvironmentName}-PrivateSubnet2
      SecurityGroups:
        - !If
          - UseEfsSgParam
          - !Ref EfsSecurityGroupId
          - !ImportValue
            Fn::Sub: ${EnvironmentName}-EfsSG

  EfsMountTarget3:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref EfsFileSystem
      SubnetId: !If
        - UsePrivateSubnet3Param
        - !Ref PrivateSubnet3
        - !ImportValue
          Fn::Sub: ${EnvironmentName}-PrivateSubnet3
      SecurityGroups:
        - !If
          - UseEfsSgParam
          - !Ref EfsSecurityGroupId
          - !ImportValue
            Fn::Sub: ${EnvironmentName}-EfsSG

  #============================================================================
  # EFS Access Points (6 total)
  #============================================================================
  EfsAccessPointServers:
    Type: AWS::EFS::AccessPoint
    Properties:
      FileSystemId: !Ref EfsFileSystem
      PosixUser:
        Uid: '1000'
        Gid: '1000'
      RootDirectory:
        Path: /servers
        CreationInfo:
          OwnerUid: '1000'
          OwnerGid: '1000'
          Permissions: '755'
      AccessPointTags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-servers

  EfsAccessPointModels:
    Type: AWS::EFS::AccessPoint
    Properties:
      FileSystemId: !Ref EfsFileSystem
      PosixUser:
        Uid: '1000'
        Gid: '1000'
      RootDirectory:
        Path: /models
        CreationInfo:
          OwnerUid: '1000'
          OwnerGid: '1000'
          Permissions: '755'
      AccessPointTags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-models

  EfsAccessPointLogs:
    Type: AWS::EFS::AccessPoint
    Properties:
      FileSystemId: !Ref EfsFileSystem
      PosixUser:
        Uid: '1000'
        Gid: '1000'
      RootDirectory:
        Path: /logs
        CreationInfo:
          OwnerUid: '1000'
          OwnerGid: '1000'
          Permissions: '755'
      AccessPointTags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-logs

  EfsAccessPointAgents:
    Type: AWS::EFS::AccessPoint
    Properties:
      FileSystemId: !Ref EfsFileSystem
      PosixUser:
        Uid: '1000'
        Gid: '1000'
      RootDirectory:
        Path: /agents
        CreationInfo:
          OwnerUid: '1000'
          OwnerGid: '1000'
          Permissions: '755'
      AccessPointTags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-agents

  EfsAccessPointAuthConfig:
    Type: AWS::EFS::AccessPoint
    Properties:
      FileSystemId: !Ref EfsFileSystem
      PosixUser:
        Uid: '1000'
        Gid: '1000'
      RootDirectory:
        Path: /auth_config
        CreationInfo:
          OwnerUid: '1000'
          OwnerGid: '1000'
          Permissions: '755'
      AccessPointTags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-auth-config

  EfsAccessPointMcpgwData:
    Type: AWS::EFS::AccessPoint
    Properties:
      FileSystemId: !Ref EfsFileSystem
      PosixUser:
        Uid: '1000'
        Gid: '1000'
      RootDirectory:
        Path: /mcpgw_data
        CreationInfo:
          OwnerUid: '1000'
          OwnerGid: '1000'
          Permissions: '755'
      AccessPointTags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-mcpgw-data


  #============================================================================
  # Secrets Manager Secrets
  #============================================================================
  
  # Database credentials secret
  KeycloakDbSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub ${EnvironmentName}/keycloak/database
      Description: Keycloak database credentials
      SecretString: !Sub |
        {
          "username": "${KeycloakDatabaseUsername}",
          "password": "${KeycloakDatabasePassword}"
        }
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-keycloak-db-secret

  # Application secret key
  SecretKeySecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub ${EnvironmentName}-secret-key
      Description: Secret key for MCP Gateway Registry
      GenerateSecretString:
        SecretStringTemplate: '{}'
        GenerateStringKey: secret_key
        PasswordLength: 64
        ExcludeCharacters: '"@/\'
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-secret-key

  # Admin password secret
  AdminPasswordSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub ${EnvironmentName}-admin-password
      Description: Admin password for MCP Gateway Registry
      GenerateSecretString:
        SecretStringTemplate: '{}'
        GenerateStringKey: admin_password
        PasswordLength: 32
        RequireEachIncludedType: true
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-admin-password

  # Keycloak client secret (placeholder, updated by init script)
  KeycloakClientSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub ${EnvironmentName}-keycloak-client-secret
      Description: Keycloak web client secret (updated by init script after deployment)
      SecretString: '{"client_secret": "placeholder-will-be-updated-by-init-script"}'
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-keycloak-client-secret

  # Keycloak M2M client secret (placeholder, updated by init script)
  KeycloakM2MClientSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub ${EnvironmentName}-keycloak-m2m-client-secret
      Description: Keycloak M2M client secret (updated by init script after deployment)
      SecretString: '{"client_secret": "placeholder-will-be-updated-by-init-script"}'
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-keycloak-m2m-client-secret

  #============================================================================
  # Aurora Serverless v2 Database
  #============================================================================
  
  # DB Subnet Group
  DbSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupName: !Sub ${EnvironmentName}-keycloak-subnet-group
      DBSubnetGroupDescription: Subnet group for Keycloak Aurora cluster
      SubnetIds:
        - !If
          - UsePrivateSubnet1Param
          - !Ref PrivateSubnet1
          - !ImportValue
            Fn::Sub: ${EnvironmentName}-PrivateSubnet1
        - !If
          - UsePrivateSubnet2Param
          - !Ref PrivateSubnet2
          - !ImportValue
            Fn::Sub: ${EnvironmentName}-PrivateSubnet2
        - !If
          - UsePrivateSubnet3Param
          - !Ref PrivateSubnet3
          - !ImportValue
            Fn::Sub: ${EnvironmentName}-PrivateSubnet3
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-keycloak-subnet-group

  # RDS Cluster Parameter Group
  DbClusterParameterGroup:
    Type: AWS::RDS::DBClusterParameterGroup
    Properties:
      DBClusterParameterGroupName: !Sub ${EnvironmentName}-keycloak-params
      Description: Keycloak Aurora MySQL parameter group
      Family: aurora-mysql8.0
      Parameters:
        character_set_server: utf8mb4
        collation_server: utf8mb4_unicode_ci
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-keycloak-params

  # Aurora Serverless v2 Cluster
  AuroraCluster:
    Type: AWS::RDS::DBCluster
    DependsOn: KeycloakDbSecret
    Properties:
      DBClusterIdentifier: !Sub ${EnvironmentName}-keycloak
      Engine: aurora-mysql
      EngineVersion: 8.0.mysql_aurora.3.08.2
      DatabaseName: keycloak
      MasterUsername: !Ref KeycloakDatabaseUsername
      MasterUserPassword: !Ref KeycloakDatabasePassword
      DBSubnetGroupName: !Ref DbSubnetGroup
      DBClusterParameterGroupName: !Ref DbClusterParameterGroup
      VpcSecurityGroupIds:
        - !If
          - UseDatabaseSgParam
          - !Ref DatabaseSecurityGroupId
          - !ImportValue
            Fn::Sub: ${EnvironmentName}-DatabaseSG
      BackupRetentionPeriod: 7
      PreferredBackupWindow: 02:00-04:00
      PreferredMaintenanceWindow: sun:04:00-sun:05:00
      StorageEncrypted: true
      KmsKeyId: !GetAtt RdsKmsKey.Arn
      DeletionProtection: false
      ServerlessV2ScalingConfiguration:
        MinCapacity: !Ref DatabaseMinACU
        MaxCapacity: !Ref DatabaseMaxACU
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-keycloak-cluster

  # Aurora Cluster Instance (Serverless v2)
  AuroraInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub ${EnvironmentName}-keycloak-instance
      DBClusterIdentifier: !Ref AuroraCluster
      DBInstanceClass: db.serverless
      Engine: aurora-mysql
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-keycloak-instance


  #============================================================================
  # RDS Proxy
  #============================================================================
  
  # IAM Role for RDS Proxy
  RdsProxyRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${EnvironmentName}-rds-proxy-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: rds.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: RdsProxySecretsAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: !Ref KeycloakDbSecret
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-rds-proxy-role

  # RDS Proxy
  RdsProxy:
    Type: AWS::RDS::DBProxy
    DependsOn: AuroraInstance
    Properties:
      DBProxyName: !Sub ${EnvironmentName}-keycloak-proxy
      EngineFamily: MYSQL
      Auth:
        - AuthScheme: SECRETS
          SecretArn: !Ref KeycloakDbSecret
          IAMAuth: DISABLED
      RoleArn: !GetAtt RdsProxyRole.Arn
      VpcSubnetIds:
        - !If
          - UsePrivateSubnet1Param
          - !Ref PrivateSubnet1
          - !ImportValue
            Fn::Sub: ${EnvironmentName}-PrivateSubnet1
        - !If
          - UsePrivateSubnet2Param
          - !Ref PrivateSubnet2
          - !ImportValue
            Fn::Sub: ${EnvironmentName}-PrivateSubnet2
        - !If
          - UsePrivateSubnet3Param
          - !Ref PrivateSubnet3
          - !ImportValue
            Fn::Sub: ${EnvironmentName}-PrivateSubnet3
      VpcSecurityGroupIds:
        - !If
          - UseDatabaseSgParam
          - !Ref DatabaseSecurityGroupId
          - !ImportValue
            Fn::Sub: ${EnvironmentName}-DatabaseSG
      RequireTLS: false
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-keycloak-proxy

  # RDS Proxy Target Group
  RdsProxyTargetGroup:
    Type: AWS::RDS::DBProxyTargetGroup
    Properties:
      DBProxyName: !Ref RdsProxy
      TargetGroupName: default
      DBClusterIdentifiers:
        - !Ref AuroraCluster

  #============================================================================
  # SSM SecureString Parameters via Custom Resource
  # CloudFormation doesn't support SecureString with dynamic values directly,
  # so we use a Lambda custom resource to create SecureString parameters
  # (matching Terraform's aws_ssm_parameter with type = "SecureString")
  #============================================================================
  SsmSecureStringLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${EnvironmentName}-ssm-securestring-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: SsmSecureStringPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*
              - Effect: Allow
                Action:
                  - ssm:PutParameter
                  - ssm:DeleteParameter
                  - ssm:GetParameter
                  - ssm:GetParameters
                  - ssm:AddTagsToResource
                  - ssm:RemoveTagsFromResource
                  - ssm:ListTagsForResource
                Resource: !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/keycloak/*
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-ssm-securestring-role

  SsmSecureStringLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub ${EnvironmentName}-ssm-securestring
      Runtime: python3.12
      Handler: index.handler
      Role: !GetAtt SsmSecureStringLambdaRole.Arn
      Timeout: 60
      Code:
        ZipFile: |
          import boto3
          import cfnresponse

          def handler(event, context):
              print(f"Event: {event}")
              ssm = boto3.client('ssm')
              
              try:
                  name = event['ResourceProperties']['Name']
                  
                  if event['RequestType'] == 'Delete':
                      try:
                          ssm.delete_parameter(Name=name)
                          print(f"Deleted parameter: {name}")
                      except ssm.exceptions.ParameterNotFound:
                          print(f"Parameter not found (already deleted): {name}")
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                      return
                  
                  # Create or Update
                  value = event['ResourceProperties']['Value']
                  description = event['ResourceProperties'].get('Description', '')
                  tags = event['ResourceProperties'].get('Tags', [])
                  
                  ssm.put_parameter(
                      Name=name,
                      Value=value,
                      Type='SecureString',
                      Description=description,
                      Overwrite=True
                  )
                  print(f"Created/Updated SecureString parameter: {name}")
                  
                  # Add tags if provided
                  if tags:
                      ssm.add_tags_to_resource(
                          ResourceType='Parameter',
                          ResourceId=name,
                          Tags=tags
                      )
                  
                  # Return the ARN
                  region = context.invoked_function_arn.split(':')[3]
                  account = context.invoked_function_arn.split(':')[4]
                  arn = f"arn:aws:ssm:{region}:{account}:parameter{name}"
                  
                  cfnresponse.send(event, context, cfnresponse.SUCCESS, {'Arn': arn})
                  
              except Exception as e:
                  print(f"Error: {str(e)}")
                  cfnresponse.send(event, context, cfnresponse.FAILED, {'Error': str(e)})
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-ssm-securestring

  # SSM SecureString Parameters (matching Terraform exactly)
  SsmKeycloakDatabaseUrl:
    Type: Custom::SsmSecureString
    DependsOn: SsmSecureStringLambda
    Properties:
      ServiceToken: !GetAtt SsmSecureStringLambda.Arn
      Name: /keycloak/database/url
      Value: !Sub jdbc:mysql://${AuroraCluster.Endpoint.Address}:3306/keycloak
      Description: Keycloak database JDBC URL
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-keycloak-db-url

  SsmKeycloakDatabaseUsername:
    Type: Custom::SsmSecureString
    DependsOn: SsmSecureStringLambda
    Properties:
      ServiceToken: !GetAtt SsmSecureStringLambda.Arn
      Name: /keycloak/database/username
      Value: !Ref KeycloakDatabaseUsername
      Description: Keycloak database username
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-keycloak-db-username

  SsmKeycloakDatabasePassword:
    Type: Custom::SsmSecureString
    DependsOn: SsmSecureStringLambda
    Properties:
      ServiceToken: !GetAtt SsmSecureStringLambda.Arn
      Name: /keycloak/database/password
      Value: !Ref KeycloakDatabasePassword
      Description: Keycloak database password
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-keycloak-db-password

  SsmKeycloakAdmin:
    Type: Custom::SsmSecureString
    DependsOn: SsmSecureStringLambda
    Properties:
      ServiceToken: !GetAtt SsmSecureStringLambda.Arn
      Name: /keycloak/admin
      Value: admin
      Description: Keycloak admin username
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-keycloak-admin

  SsmKeycloakAdminPassword:
    Type: Custom::SsmSecureString
    DependsOn: SsmSecureStringLambda
    Properties:
      ServiceToken: !GetAtt SsmSecureStringLambda.Arn
      Name: /keycloak/admin_password
      Value: !Ref KeycloakAdminPassword
      Description: Keycloak admin password
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-keycloak-admin-password

  #============================================================================
  # EFS Initialization Lambda (scopes.yml)
  # Writes the scopes.yml configuration file to EFS auth_config directory
  # This is the CloudFormation equivalent of Terraform's run-scopes-init-task.sh
  #============================================================================
  EfsInitLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${EnvironmentName}-efs-init-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Policies:
        - PolicyName: EfsInitPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - elasticfilesystem:ClientMount
                  - elasticfilesystem:ClientWrite
                  - elasticfilesystem:DescribeMountTargets
                Resource: !Sub arn:aws:elasticfilesystem:${AWS::Region}:${AWS::AccountId}:file-system/${EfsFileSystem}
              - Effect: Allow
                Action:
                  - elasticfilesystem:ClientMount
                  - elasticfilesystem:ClientWrite
                Resource: !Sub arn:aws:elasticfilesystem:${AWS::Region}:${AWS::AccountId}:access-point/${EfsAccessPointAuthConfig}
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-efs-init-role

  EfsInitLambda:
    Type: AWS::Lambda::Function
    DependsOn:
      - EfsMountTarget1
      - EfsMountTarget2
      - EfsMountTarget3
    Properties:
      FunctionName: !Sub ${EnvironmentName}-efs-init
      Runtime: python3.12
      Handler: index.handler
      Role: !GetAtt EfsInitLambdaRole.Arn
      Timeout: 120
      MemorySize: 256
      VpcConfig:
        SecurityGroupIds:
          - !If
            - UseEfsSgParam
            - !Ref EfsSecurityGroupId
            - !ImportValue
              Fn::Sub: ${EnvironmentName}-EfsSG
        SubnetIds:
          - !If
            - UsePrivateSubnet1Param
            - !Ref PrivateSubnet1
            - !ImportValue
              Fn::Sub: ${EnvironmentName}-PrivateSubnet1
      FileSystemConfigs:
        - Arn: !GetAtt EfsAccessPointAuthConfig.Arn
          LocalMountPath: /mnt/efs
      Code:
        ZipFile: |
          import os
          import cfnresponse

          SCOPES_CONTENT = '''# Scopes Configuration for MCP Gateway Registry
          UI-Scopes:
            mcp-registry-admin:
              list_agents: [all]
              get_agent: [all]
              publish_agent: [all]
              modify_agent: [all]
              delete_agent: [all]
              list_service: [all]
              register_service: [all]
              health_check_service: [all]
              toggle_service: [all]
              modify_service: [all]
            registry-admins:
              list_agents: [all]
              get_agent: [all]
              publish_agent: [all]
              modify_agent: [all]
              delete_agent: [all]
              list_service: [all]
              register_service: [all]
              health_check_service: [all]
              toggle_service: [all]
              modify_service: [all]
            registry-users-lob1:
              list_agents: [/code-reviewer, /test-automation]
              get_agent: [/code-reviewer, /test-automation]
              publish_agent: [/code-reviewer, /test-automation]
              modify_agent: [/code-reviewer, /test-automation]
              delete_agent: [/code-reviewer, /test-automation]
              list_service: [currenttime, mcpgw]
              health_check_service: [currenttime, mcpgw]
            registry-users-lob2:
              list_agents: [/data-analysis, /security-analyzer]
              get_agent: [/data-analysis, /security-analyzer]
              publish_agent: [/data-analysis, /security-analyzer]
              modify_agent: [/data-analysis, /security-analyzer]
              delete_agent: [/data-analysis, /security-analyzer]
              list_service: [realserverfaketools, mcpgw, fininfo]
              health_check_service: [realserverfaketools, mcpgw, fininfo]

          group_mappings:
            mcp-registry-admin:
              - mcp-registry-admin
              - mcp-servers-unrestricted/read
              - mcp-servers-unrestricted/execute
            registry-admins:
              - registry-admins
            registry-users-lob1:
              - registry-users-lob1
            registry-users-lob2:
              - registry-users-lob2
            mcp-servers-unrestricted:
              - mcp-servers-unrestricted/read
              - mcp-servers-unrestricted/execute

          mcp-servers-unrestricted/read:
            - server: '*'
              methods: [initialize, notifications/initialized, ping, tools/list, tools/call, resources/list, resources/templates/list, GET]
              tools: '*'

          mcp-servers-unrestricted/execute:
            - server: '*'
              methods: [initialize, notifications/initialized, ping, tools/list, tools/call, resources/list, resources/templates/list, GET, POST, PUT, DELETE]
              tools: '*'

          registry-users-lob1:
            - server: api
              methods: [initialize, GET]
            - server: currenttime
              methods: [initialize, notifications/initialized, ping, tools/list, tools/call, resources/list, resources/templates/list]
              tools: [current_time_by_timezone]
            - server: mcpgw
              methods: [initialize, notifications/initialized, ping, tools/list, tools/call, resources/list, resources/templates/list]
              tools: [intelligent_tool_finder]
            - agents:
                actions:
                  - action: list_agents
                    resources: [/code-reviewer, /test-automation]
                  - action: get_agent
                    resources: [/code-reviewer, /test-automation]
                  - action: publish_agent
                    resources: [/code-reviewer, /test-automation]
                  - action: modify_agent
                    resources: [/code-reviewer, /test-automation]
                  - action: delete_agent
                    resources: [/code-reviewer, /test-automation]

          registry-users-lob2:
            - server: api
              methods: [initialize, GET]
            - server: realserverfaketools
              methods: [initialize, notifications/initialized, ping, tools/list, tools/call, resources/list, resources/templates/list]
              tools: [quantum_flux_analyzer, neural_pattern_synthesizer, hyper_dimensional_mapper]
            - server: mcpgw
              methods: [initialize, notifications/initialized, ping, tools/list, tools/call, resources/list, resources/templates/list]
              tools: [intelligent_tool_finder]
            - server: fininfo
              methods: [initialize, notifications/initialized, ping, tools/list, tools/call, resources/list, resources/templates/list]
              tools: [get_stock_aggregates, print_stock_data]
            - agents:
                actions:
                  - action: list_agents
                    resources: [/data-analysis, /security-analyzer]
                  - action: get_agent
                    resources: [/data-analysis, /security-analyzer]
                  - action: publish_agent
                    resources: [/data-analysis, /security-analyzer]
                  - action: modify_agent
                    resources: [/data-analysis, /security-analyzer]
                  - action: delete_agent
                    resources: [/data-analysis, /security-analyzer]

          registry-admins:
            - server: '*'
              methods: [all]
              tools: [all]
            - agents:
                actions:
                  - action: list_agents
                    resources: [all]
                  - action: get_agent
                    resources: [all]
                  - action: publish_agent
                    resources: [all]
                  - action: modify_agent
                    resources: [all]
                  - action: delete_agent
                    resources: [all]
          '''

          def handler(event, context):
              print(f"Event: {event}")
              
              try:
                  if event['RequestType'] == 'Delete':
                      # On delete, optionally remove the file (or leave it)
                      scopes_path = '/mnt/efs/scopes.yml'
                      if os.path.exists(scopes_path):
                          os.remove(scopes_path)
                          print(f"Deleted {scopes_path}")
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                      return
                  
                  # Create or Update - write scopes.yml to EFS
                  scopes_path = '/mnt/efs/scopes.yml'
                  
                  # Ensure directory exists
                  os.makedirs('/mnt/efs', exist_ok=True)
                  
                  # Write the scopes.yml file
                  with open(scopes_path, 'w') as f:
                      f.write(SCOPES_CONTENT.strip())
                  
                  # Verify file was written
                  if os.path.exists(scopes_path):
                      file_size = os.path.getsize(scopes_path)
                      print(f"Successfully wrote {scopes_path} ({file_size} bytes)")
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {
                          'FilePath': scopes_path,
                          'FileSize': str(file_size)
                      })
                  else:
                      raise Exception(f"Failed to write {scopes_path}")
                      
              except Exception as e:
                  print(f"Error: {str(e)}")
                  cfnresponse.send(event, context, cfnresponse.FAILED, {'Error': str(e)})
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-efs-init

  # Custom Resource to trigger EFS initialization
  EfsInitTrigger:
    Type: Custom::EfsInit
    DependsOn:
      - EfsInitLambda
      - EfsMountTarget1
      - EfsMountTarget2
      - EfsMountTarget3
    Properties:
      ServiceToken: !GetAtt EfsInitLambda.Arn
      # Add a version to force update when scopes.yml changes
      Version: '1.0.0'

  #============================================================================
  # MCP Server Registration Lambda
  # Writes MCP server definition JSON files to EFS servers directory
  # This registers the default MCP servers (currenttime, mcpgw, realserverfaketools)
  #============================================================================
  McpServerInitLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${EnvironmentName}-mcp-server-init-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Policies:
        - PolicyName: EfsAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - elasticfilesystem:ClientMount
                  - elasticfilesystem:ClientWrite
                  - elasticfilesystem:ClientRootAccess
                Resource: !GetAtt EfsFileSystem.Arn
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-mcp-server-init-role

  McpServerInitLambda:
    Type: AWS::Lambda::Function
    DependsOn:
      - EfsMountTarget1
      - EfsMountTarget2
      - EfsMountTarget3
    Properties:
      FunctionName: !Sub ${EnvironmentName}-mcp-server-init
      Runtime: python3.12
      Handler: index.handler
      Role: !GetAtt McpServerInitLambdaRole.Arn
      Timeout: 120
      MemorySize: 256
      VpcConfig:
        SecurityGroupIds:
          - !If
            - UseEfsSgParam
            - !Ref EfsSecurityGroupId
            - !ImportValue
              Fn::Sub: ${EnvironmentName}-EfsSG
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
          - !Ref PrivateSubnet3
      FileSystemConfigs:
        - Arn: !GetAtt EfsAccessPointServers.Arn
          LocalMountPath: /mnt/efs
      Code:
        ZipFile: |
          import json
          import os
          import cfnresponse
          
          # MCP Server definitions for the workshop
          MCP_SERVERS = [
              {
                  "server_name": "currenttime-server",
                  "path": "/mcp/currenttime",
                  "description": "MCP server that provides current time information",
                  "tags": ["time", "utility", "demo"],
                  "proxy_pass_url": "http://currenttime-server:8000",
                  "is_python": True,
                  "num_tools": 1,
                  "tool_list": [
                      {
                          "name": "get_current_time",
                          "description": "Get the current time in various formats"
                      }
                  ]
              },
              {
                  "server_name": "mcpgw-server",
                  "path": "/mcp/mcpgw",
                  "description": "MCP Gateway server for federated tool access",
                  "tags": ["gateway", "federation", "tools"],
                  "proxy_pass_url": "http://mcpgw-server:8003",
                  "is_python": True,
                  "num_tools": 5,
                  "tool_list": []
              },
              {
                  "server_name": "realserverfaketools-server",
                  "path": "/mcp/realserverfaketools",
                  "description": "Demo MCP server with simulated tools for testing",
                  "tags": ["demo", "testing", "simulation"],
                  "proxy_pass_url": "http://realserverfaketools-server:8002",
                  "is_python": True,
                  "num_tools": 3,
                  "tool_list": [
                      {
                          "name": "fake_weather",
                          "description": "Get simulated weather data"
                      },
                      {
                          "name": "fake_stock",
                          "description": "Get simulated stock prices"
                      },
                      {
                          "name": "fake_news",
                          "description": "Get simulated news headlines"
                      }
                  ]
              }
          ]
          
          def handler(event, context):
              print(f"Event: {json.dumps(event)}")
              
              try:
                  if event['RequestType'] == 'Delete':
                      # On delete, optionally remove the files
                      for server in MCP_SERVERS:
                          server_file = f"/mnt/efs/{server['server_name']}.json"
                          if os.path.exists(server_file):
                              os.remove(server_file)
                              print(f"Removed {server_file}")
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                      return
                  
                  # Create or Update - write server definition files to EFS
                  os.makedirs('/mnt/efs', exist_ok=True)
                  
                  created_servers = []
                  for server in MCP_SERVERS:
                      server_file = f"/mnt/efs/{server['server_name']}.json"
                      with open(server_file, 'w') as f:
                          json.dump(server, f, indent=2)
                      print(f"Created {server_file}")
                      created_servers.append(server['server_name'])
                  
                  cfnresponse.send(event, context, cfnresponse.SUCCESS, {
                      'ServersCreated': ','.join(created_servers)
                  })
                  
              except Exception as e:
                  print(f"Error: {str(e)}")
                  cfnresponse.send(event, context, cfnresponse.FAILED, {
                      'Error': str(e)
                  })
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-mcp-server-init

  McpServerInitTrigger:
    Type: Custom::McpServerInit
    DependsOn:
      - McpServerInitLambda
      - EfsMountTarget1
      - EfsMountTarget2
      - EfsMountTarget3
    Properties:
      ServiceToken: !GetAtt McpServerInitLambda.Arn
      # Add a version to force update when server definitions change
      Version: '1.0.0'

  #============================================================================
  # A2A Agent Registration Lambda
  # Writes A2A agent definition JSON files to EFS agents directory
  # This registers the default agents (flight-booking, travel-assistant)
  #============================================================================
  AgentInitLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${EnvironmentName}-agent-init-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Policies:
        - PolicyName: EfsAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - elasticfilesystem:ClientMount
                  - elasticfilesystem:ClientWrite
                  - elasticfilesystem:ClientRootAccess
                Resource: !GetAtt EfsFileSystem.Arn
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-agent-init-role

  AgentInitLambda:
    Type: AWS::Lambda::Function
    DependsOn:
      - EfsMountTarget1
      - EfsMountTarget2
      - EfsMountTarget3
    Properties:
      FunctionName: !Sub ${EnvironmentName}-agent-init
      Runtime: python3.12
      Handler: index.handler
      Role: !GetAtt AgentInitLambdaRole.Arn
      Timeout: 120
      MemorySize: 256
      VpcConfig:
        SecurityGroupIds:
          - !If
            - UseEfsSgParam
            - !Ref EfsSecurityGroupId
            - !ImportValue
              Fn::Sub: ${EnvironmentName}-EfsSG
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
          - !Ref PrivateSubnet3
      FileSystemConfigs:
        - Arn: !GetAtt EfsAccessPointAgents.Arn
          LocalMountPath: /mnt/efs
      Code:
        ZipFile: |
          import json
          import os
          import cfnresponse
          
          # A2A Agent definitions for the workshop
          A2A_AGENTS = [
              {
                  "name": "Flight Booking Agent",
                  "path": "/a2a/flight-booking",
                  "description": "AI agent that helps users search and book flights. Supports searching for flights, managing bookings, and handling cancellations.",
                  "version": "1.0.0",
                  "url": "http://flight-booking-agent.mcp-gateway.local:9000",
                  "provider": {
                      "organization": "MCP Gateway Workshop",
                      "url": "https://github.com/aws-samples/mcp-gateway"
                  },
                  "capabilities": {
                      "streaming": True,
                      "pushNotifications": False,
                      "stateTransitionHistory": True
                  },
                  "defaultInputModes": ["text"],
                  "defaultOutputModes": ["text"],
                  "skills": [
                      {
                          "id": "search_flights",
                          "name": "Search Flights",
                          "description": "Search for available flights between cities",
                          "tags": ["search", "flights"]
                      },
                      {
                          "id": "book_flight",
                          "name": "Book Flight",
                          "description": "Book a selected flight",
                          "tags": ["booking", "reservation"]
                      },
                      {
                          "id": "manage_booking",
                          "name": "Manage Booking",
                          "description": "View or cancel existing bookings",
                          "tags": ["booking", "management"]
                      }
                  ],
                  "tags": ["travel", "booking", "flights", "a2a"]
              },
              {
                  "name": "Travel Assistant Agent",
                  "path": "/a2a/travel-assistant",
                  "description": "AI travel assistant that coordinates with other agents to help plan trips. Can search flights via the Flight Booking Agent and provide travel recommendations.",
                  "version": "1.0.0",
                  "url": "http://travel-assistant-agent.mcp-gateway.local:9000",
                  "provider": {
                      "organization": "MCP Gateway Workshop",
                      "url": "https://github.com/aws-samples/mcp-gateway"
                  },
                  "capabilities": {
                      "streaming": True,
                      "pushNotifications": False,
                      "stateTransitionHistory": True
                  },
                  "defaultInputModes": ["text"],
                  "defaultOutputModes": ["text"],
                  "skills": [
                      {
                          "id": "plan_trip",
                          "name": "Plan Trip",
                          "description": "Help plan a complete trip including flights",
                          "tags": ["planning", "trip"]
                      },
                      {
                          "id": "travel_recommendations",
                          "name": "Travel Recommendations",
                          "description": "Provide destination and travel recommendations",
                          "tags": ["recommendations", "destinations"]
                      }
                  ],
                  "tags": ["travel", "assistant", "planning", "a2a"]
              }
          ]
          
          def path_to_filename(path):
              """Convert agent path to safe filename."""
              normalized = path.lstrip("/").replace("/", "_")
              if not normalized.endswith("_agent.json"):
                  normalized += "_agent.json"
              return normalized
          
          def handler(event, context):
              print(f"Event: {json.dumps(event)}")
              
              try:
                  if event['RequestType'] == 'Delete':
                      # On delete, optionally remove the files
                      for agent in A2A_AGENTS:
                          agent_file = f"/mnt/efs/{path_to_filename(agent['path'])}"
                          if os.path.exists(agent_file):
                              os.remove(agent_file)
                              print(f"Removed {agent_file}")
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                      return
                  
                  # Create or Update - write agent definition files to EFS
                  os.makedirs('/mnt/efs', exist_ok=True)
                  
                  created_agents = []
                  for agent in A2A_AGENTS:
                      agent_file = f"/mnt/efs/{path_to_filename(agent['path'])}"
                      with open(agent_file, 'w') as f:
                          json.dump(agent, f, indent=2)
                      print(f"Created {agent_file}")
                      created_agents.append(agent['name'])
                  
                  cfnresponse.send(event, context, cfnresponse.SUCCESS, {
                      'AgentsCreated': ','.join(created_agents)
                  })
                  
              except Exception as e:
                  print(f"Error: {str(e)}")
                  cfnresponse.send(event, context, cfnresponse.FAILED, {
                      'Error': str(e)
                  })
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-agent-init

  AgentInitTrigger:
    Type: Custom::AgentInit
    DependsOn:
      - AgentInitLambda
      - EfsMountTarget1
      - EfsMountTarget2
      - EfsMountTarget3
    Properties:
      ServiceToken: !GetAtt AgentInitLambda.Arn
      # Add a version to force update when agent definitions change
      Version: '1.0.0'

#============================================================================
# Outputs
#============================================================================
Outputs:
  # EFS Outputs
  EfsFileSystemId:
    Description: EFS File System ID
    Value: !Ref EfsFileSystem
    Export:
      Name: !Sub ${EnvironmentName}-EfsFileSystemId

  EfsAccessPointServersId:
    Description: EFS Access Point ID for servers
    Value: !Ref EfsAccessPointServers
    Export:
      Name: !Sub ${EnvironmentName}-EfsAccessPointServers

  EfsAccessPointModelsId:
    Description: EFS Access Point ID for models
    Value: !Ref EfsAccessPointModels
    Export:
      Name: !Sub ${EnvironmentName}-EfsAccessPointModels

  EfsAccessPointLogsId:
    Description: EFS Access Point ID for logs
    Value: !Ref EfsAccessPointLogs
    Export:
      Name: !Sub ${EnvironmentName}-EfsAccessPointLogs

  EfsAccessPointAgentsId:
    Description: EFS Access Point ID for agents
    Value: !Ref EfsAccessPointAgents
    Export:
      Name: !Sub ${EnvironmentName}-EfsAccessPointAgents

  EfsAccessPointAuthConfigId:
    Description: EFS Access Point ID for auth config
    Value: !Ref EfsAccessPointAuthConfig
    Export:
      Name: !Sub ${EnvironmentName}-EfsAccessPointAuthConfig

  EfsAccessPointMcpgwDataId:
    Description: EFS Access Point ID for mcpgw data
    Value: !Ref EfsAccessPointMcpgwData
    Export:
      Name: !Sub ${EnvironmentName}-EfsAccessPointMcpgwData

  # Database Outputs
  AuroraClusterEndpoint:
    Description: Aurora cluster endpoint
    Value: !GetAtt AuroraCluster.Endpoint.Address
    Export:
      Name: !Sub ${EnvironmentName}-AuroraClusterEndpoint

  AuroraClusterPort:
    Description: Aurora cluster port
    Value: !GetAtt AuroraCluster.Endpoint.Port
    Export:
      Name: !Sub ${EnvironmentName}-AuroraClusterPort

  RdsProxyEndpoint:
    Description: RDS Proxy endpoint
    Value: !GetAtt RdsProxy.Endpoint
    Export:
      Name: !Sub ${EnvironmentName}-RdsProxyEndpoint

  # Secrets Outputs
  KeycloakDbSecretArn:
    Description: Keycloak database secret ARN
    Value: !Ref KeycloakDbSecret
    Export:
      Name: !Sub ${EnvironmentName}-KeycloakDbSecretArn

  SecretKeySecretArn:
    Description: Application secret key ARN
    Value: !Ref SecretKeySecret
    Export:
      Name: !Sub ${EnvironmentName}-SecretKeySecretArn

  AdminPasswordSecretArn:
    Description: Admin password secret ARN
    Value: !Ref AdminPasswordSecret
    Export:
      Name: !Sub ${EnvironmentName}-AdminPasswordSecretArn

  KeycloakClientSecretArn:
    Description: Keycloak client secret ARN
    Value: !Ref KeycloakClientSecret
    Export:
      Name: !Sub ${EnvironmentName}-KeycloakClientSecretArn

  KeycloakM2MClientSecretArn:
    Description: Keycloak M2M client secret ARN
    Value: !Ref KeycloakM2MClientSecret
    Export:
      Name: !Sub ${EnvironmentName}-KeycloakM2MClientSecretArn

  # SSM Parameter Outputs (for Keycloak - matching Terraform)
  SsmKeycloakAdminArn:
    Description: SSM Parameter ARN for Keycloak admin username
    Value: !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/keycloak/admin
    Export:
      Name: !Sub ${EnvironmentName}-SsmKeycloakAdminArn

  SsmKeycloakAdminPasswordArn:
    Description: SSM Parameter ARN for Keycloak admin password
    Value: !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/keycloak/admin_password
    Export:
      Name: !Sub ${EnvironmentName}-SsmKeycloakAdminPasswordArn

  SsmKeycloakDatabaseUrlArn:
    Description: SSM Parameter ARN for Keycloak database URL
    Value: !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/keycloak/database/url
    Export:
      Name: !Sub ${EnvironmentName}-SsmKeycloakDatabaseUrlArn

  SsmKeycloakDatabaseUsernameArn:
    Description: SSM Parameter ARN for Keycloak database username
    Value: !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/keycloak/database/username
    Export:
      Name: !Sub ${EnvironmentName}-SsmKeycloakDatabaseUsernameArn

  SsmKeycloakDatabasePasswordArn:
    Description: SSM Parameter ARN for Keycloak database password
    Value: !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/keycloak/database/password
    Export:
      Name: !Sub ${EnvironmentName}-SsmKeycloakDatabasePasswordArn

  # KMS Outputs
  RdsKmsKeyArn:
    Description: RDS KMS key ARN
    Value: !GetAtt RdsKmsKey.Arn
    Export:
      Name: !Sub ${EnvironmentName}-RdsKmsKeyArn

  # EFS Init Status
  EfsInitStatus:
    Description: EFS initialization status (scopes.yml written to auth_config)
    Value: 'Initialized'
    Export:
      Name: !Sub ${EnvironmentName}-EfsInitStatus

  # MCP Server Init Status
  McpServerInitStatus:
    Description: MCP Server initialization status (server definitions written to EFS)
    Value: 'Initialized'
    Export:
      Name: !Sub ${EnvironmentName}-McpServerInitStatus

  # A2A Agent Init Status
  AgentInitStatus:
    Description: A2A Agent initialization status (agent definitions written to EFS)
    Value: 'Initialized'
    Export:
      Name: !Sub ${EnvironmentName}-AgentInitStatus
