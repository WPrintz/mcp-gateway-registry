# Global configuration - these values are passed to all subcharts
global:
  # Domain configuration - update this to your actual domain
  domain: "DOMAIN"

  # Security settings - CHANGE THESE IN PRODUCTION
  secretKey: "aReallyGoodKeyThatShouldBeChanged"

  # Authentication Provider Configuration
  # Choose ONE provider: keycloak or entra
  authProvider:
    # Provider type: "keycloak" or "entra"
    type: keycloak

  # Common ingress settings
  ingress:
    className: alb
    tls: true
    annotations:
      alb.ingress.kubernetes.io/listen-ports: '[{"HTTPS": 443}]'
      alb.ingress.kubernetes.io/scheme: internet-facing
      alb.ingress.kubernetes.io/ssl-redirect: '443'
      alb.ingress.kubernetes.io/target-type: ip
      alb.ingress.kubernetes.io/success-codes: 200,302

mongodb-kubernetes:
  operator:
    enableClusterMongoDBRoles: false
    telemetry:
      installClusterRole: false

# MongoDB configuration
mongodb:
  enabled: true
  user: my-user # username for MongDB
  password: CHANGEME # Set the password for the MongoDB user

# Keycloak configuration
# Set create: true to deploy Keycloak as part of this stack
# Set create: false to use an external Keycloak instance
keycloak:
  create: true  # Deploy Keycloak in this stack (set to false to use external Keycloak)
  image:
    repository: bitnamilegacy/keycloak

  global:
    security:
      allowInsecureImages: true

  postgresql:
    image:
      repository: bitnamilegacy/postgresql

  extraEnvVars:
    - name: KC_PROXY
      value: edge
    - name: KC_PROXY_HEADERS
      value: xforwarded

  ingress:
    enabled: false  # We use a custom ingress template that supports global.domain

  # Lifecycle hook to configure realm SSL settings
  lifecycleHooks:
    postStart:
      exec:
        command:
          - "/bin/bash"
          - "-c"
          - |
            (
              echo "PostStart: Waiting for Keycloak to be ready..."
              for i in {1..120}; do
                if curl -sf http://localhost:8080/realms/$KC_SPI_ADMIN_REALM > /dev/null 2>&1; then
                  echo "Keycloak ready after $i attempts"
                  break
                fi
                sleep 5
              done
              sleep 10
              echo "Configuring $KC_SPI_ADMIN_REALM realm..."
              /opt/bitnami/keycloak/bin/kcadm.sh config credentials \
                --config /tmp/kcadm.config \
                --server http://localhost:8080 \
                --realm $KC_SPI_ADMIN_REALM \
                --user $KC_BOOTSTRAP_ADMIN_USERNAME \
                --password $(cat $KC_BOOTSTRAP_ADMIN_PASSWORD_FILE)
              /opt/bitnami/keycloak/bin/kcadm.sh update \
                --config /tmp/kcadm.config \
                realms/$KC_SPI_ADMIN_REALM \
                -s sslRequired=NONE
              echo "âœ“ $KC_SPI_ADMIN_REALM realm configured!"
            ) > /tmp/poststart-config.log 2>&1 &

# Keycloak configuration job
# Automatically enabled when global.authProvider.type = "keycloak"
# Set to false to skip configuration (e.g., when using pre-configured Keycloak)
keycloak-configure:
  enabled: true  # Set to false to skip Keycloak configuration
  keycloak:
    realm: mcp-gateway
    adminUser: user
  # authServer.externalUrl will be templated in the subchart using global.domain

# Mongodb configuration job
mongodb-configure:
  enabled: true # Whether to run the MongoDB configuration job

# Registry service configuration
registry:
  # app.secretKey and app.authServerUrl will be templated in the subchart using global values
  app:
    replicas: 1
  ingress:
    enabled: true
    ingressClassName: alb
    annotations:
      alb.ingress.kubernetes.io/listen-ports: '[{"HTTPS": 443}]'
      alb.ingress.kubernetes.io/scheme: internet-facing
      alb.ingress.kubernetes.io/ssl-redirect: '443'
      alb.ingress.kubernetes.io/target-type: ip
      alb.ingress.kubernetes.io/success-codes: 200,302

# Auth server configuration
auth-server:
  # app.secretKey, app.externalUrl, app.sessionCookieDomain will be templated using global values
  app:
    replicas: 1
  
  # Authentication provider configuration (inherited from global.authProvider)
  authProvider:
    type: keycloak  # Will be overridden by global.authProvider.type
  
  # Keycloak settings (used when global.authProvider.type = "keycloak")
  keycloak:
    realm: mcp-gateway
    # externalUrl will be templated in the subchart using global.domain
  
  # Entra ID settings (used when global.authProvider.type = "entra")
  entra:
    clientId: ""
    clientSecret: ""
    tenantId: ""

  ingress:
    enabled: true
    ingressClassName: alb
    annotations:
      alb.ingress.kubernetes.io/listen-ports: '[{"HTTPS": 443}]'
      alb.ingress.kubernetes.io/scheme: internet-facing
      alb.ingress.kubernetes.io/ssl-redirect: '443'
      alb.ingress.kubernetes.io/target-type: ip
      alb.ingress.kubernetes.io/success-codes: 200,302
      alb.ingress.kubernetes.io/healthcheck-path: /health
