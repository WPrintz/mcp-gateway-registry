{{/*
Shared OAuth provider secret for auth-server and registry.
Contains the auth provider type and identity provider credentials
(Keycloak or Entra) that both services need.
*/}}
{{- $secretName := .Values.global.oauthProviderSecretName | default "oauth-provider-secret" }}
{{- $existingSecret := lookup "v1" "Secret" .Release.Namespace $secretName }}
{{- $authProviderType := .Values.global.authProvider.type | default "keycloak" }}
{{- /* Resolve Keycloak URLs and realm */ -}}
{{- $routingMode := .Values.global.ingress.routingMode | default "subdomain" }}
{{- $domain := .Values.global.domain | default "localhost" }}
{{- $protocol := ternary "https" "http" .Values.global.ingress.tls }}
{{- $keycloakPath := .Values.global.ingress.paths.keycloak | default "/keycloak" }}
{{- $keycloakUrl := printf "http://%s-keycloak-headless.%s.svc.cluster.local:8080" .Release.Name .Release.Namespace }}
{{- $keycloakExternalUrl := "" }}
{{- if eq $routingMode "path" }}
  {{- $keycloakUrl = printf "%s%s" $keycloakUrl $keycloakPath }}
  {{- $keycloakExternalUrl = printf "%s://%s%s" $protocol $domain $keycloakPath }}
{{- else }}
  {{- $keycloakExternalUrl = printf "%s://keycloak.%s" $protocol $domain }}
{{- end }}
{{- $keycloakRealm := .Values.global.authProvider.keycloak.realm | default "mcp-gateway" }}
{{- /* Resolve Entra credentials - prefer values, fallback to existing secret */ -}}
{{- $entraClientId := "" }}
{{- $entraClientSecret := "" }}
{{- $entraTenantId := "" }}
{{- if (index .Values "auth-server") }}
  {{- if (index .Values "auth-server" "entra") }}
    {{- $entraClientId = (index .Values "auth-server" "entra" "clientId") | default "" }}
    {{- $entraClientSecret = (index .Values "auth-server" "entra" "clientSecret") | default "" }}
    {{- $entraTenantId = (index .Values "auth-server" "entra" "tenantId") | default "" }}
  {{- end }}
{{- end }}
{{- /* Persist Entra credentials across upgrades */ -}}
{{- if and (not $entraClientId) $existingSecret }}
  {{- if index $existingSecret.data "ENTRA_CLIENT_ID" }}
    {{- $entraClientId = index $existingSecret.data "ENTRA_CLIENT_ID" | b64dec }}
  {{- end }}
{{- end }}
{{- if and (not $entraClientSecret) $existingSecret }}
  {{- if index $existingSecret.data "ENTRA_CLIENT_SECRET" }}
    {{- $entraClientSecret = index $existingSecret.data "ENTRA_CLIENT_SECRET" | b64dec }}
  {{- end }}
{{- end }}
{{- if and (not $entraTenantId) $existingSecret }}
  {{- if index $existingSecret.data "ENTRA_TENANT_ID" }}
    {{- $entraTenantId = index $existingSecret.data "ENTRA_TENANT_ID" | b64dec }}
  {{- end }}
{{- end }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  namespace: {{ .Release.Namespace | quote }}
  labels:
    {{- include "mcp-gateway-registry-stack.labels" . | nindent 4 }}
type: Opaque
data:
  AUTH_PROVIDER: {{ $authProviderType | b64enc | quote }}
  {{- if eq $authProviderType "keycloak" }}
  KEYCLOAK_ENABLED: {{ "true" | b64enc | quote }}
  KEYCLOAK_URL: {{ $keycloakUrl | b64enc | quote }}
  KEYCLOAK_EXTERNAL_URL: {{ $keycloakExternalUrl | b64enc | quote }}
  KEYCLOAK_REALM: {{ $keycloakRealm | b64enc | quote }}
  {{- else if eq $authProviderType "entra" }}
  ENTRA_ENABLED: {{ "true" | b64enc | quote }}
  ENTRA_CLIENT_ID: {{ $entraClientId | b64enc | quote }}
  ENTRA_CLIENT_SECRET: {{ $entraClientSecret | b64enc | quote }}
  ENTRA_TENANT_ID: {{ $entraTenantId | b64enc | quote }}
  {{- end }}
